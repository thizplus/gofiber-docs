# Part 4: AI APIs (OpenAI Integration)

## Overview
ระบบ AI สำหรับการค้นหาอัจฉริยะและการสนทนา ใช้ OpenAI GPT-4o-mini

## Base URL
```
/api/v1/ai
```

---

## 4.1 AI Search (ค้นหาอัจฉริยะ)

### Endpoint
```
GET /api/v1/ai/search
```

### Authentication
Optional (ถ้า login จะบันทึกประวัติ)

### Description
ค้นหาข้อมูลจาก Google แล้วให้ AI สรุปผลลัพธ์เป็นภาษาที่เข้าใจง่าย พร้อมแหล่งอ้างอิง

### Query Parameters
```typescript
interface AISearchRequest {
  q: string;      // required, 1-500 chars - คำค้นหา
  lang?: string;  // optional, 2 chars (e.g., "th", "en")
}
```

### Example Request
```
GET /api/v1/ai/search?q=ที่เที่ยวกรุงเทพ
```

### Response
```typescript
interface AISearchResponse {
  query: string;             // คำค้นหา
  summary: string;           // คำตอบจาก AI (Markdown format)
  sources: MessageSource[];  // แหล่งอ้างอิง
  keywords?: string[];       // คำสำคัญที่เกี่ยวข้อง
}

interface MessageSource {
  title: string;     // หัวข้อ
  url: string;       // URL
  snippet?: string;  // ข้อความสรุป
}
```

### Example Response
```json
{
  "success": true,
  "message": "AI search completed",
  "data": {
    "query": "ที่เที่ยวกรุงเทพ",
    "summary": "# ที่เที่ยวกรุงเทพ น่าสนใจ\n\n## ที่เที่ยวพิเศษ\n- **SkyWalk King Power Mahanakhon**\n  - ชมวิวกรุงเทพจากมุมสูง\n- **วัดพระศรีรัตนศาสดาราม (วัดพระแก้ว)**\n  - วัดสำคัญในกรุงเทพฯ มีสถาปัตยกรรมที่งดงาม\n\n## ตลาดและแหล่งช็อปปิ้ง\n- **ตลาดนัดจตุจักร**\n- **ตลาดน้ำตลิ่งชัน**\n\n---\n\n### คำถาม follow-up\n1. ต้องการข้อมูลเกี่ยวกับที่พักไหม?\n2. มีความสนใจในกิจกรรมพิเศษไหม?",
    "sources": [
      {
        "title": "55 ที่เที่ยวกรุงเทพ ถ่ายรูปสวย",
        "url": "https://travel.trueid.net/detail/5W3XRDV9G25",
        "snippet": "อัปเดต 55 ที่เที่ยวกรุงเทพ ถ่ายรูปสวยในกรุงเทพ..."
      },
      {
        "title": "30 ที่เที่ยวกรุงเทพ ปักหมุดแลนด์มาร์กฮิต",
        "url": "https://chillpainai.com/scoop/16654",
        "snippet": "30 ที่เที่ยวกรุงเทพ ปักหมุดแลนด์มาร์กฮิต..."
      }
    ]
  }
}
```

---

## 4.2 AI Chat Sessions (การสนทนากับ AI)

### Authentication
**Required** - ทุก endpoint ต้อง login

---

### 4.2.1 Create Chat Session (สร้างเซสชันใหม่)

```
POST /api/v1/ai/chat
```

### Request Body
```typescript
interface CreateAIChatRequest {
  query: string;  // required, 1-500 chars - คำถามแรก
}
```

### Example Request
```json
{
  "query": "แนะนำที่เที่ยวกรุงเทพหน่อย"
}
```

### Response
```typescript
interface AIChatSessionDetailResponse {
  id: string;                      // UUID ของ session
  title: string;                   // ชื่อ session (จาก AI)
  initialQuery: string;            // คำถามแรก
  messages: AIChatMessageResponse[];
  createdAt: string;
  updatedAt: string;
}

interface AIChatMessageResponse {
  id: string;
  sessionId: string;
  role: 'user' | 'assistant';
  content: string;
  sources?: MessageSource[];
  createdAt: string;
}
```

### Example Response
```json
{
  "success": true,
  "message": "Chat session created",
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "title": "ที่เที่ยวกรุงเทพ",
    "initialQuery": "แนะนำที่เที่ยวกรุงเทพหน่อย",
    "messages": [
      {
        "id": "660e8400-e29b-41d4-a716-446655440001",
        "sessionId": "550e8400-e29b-41d4-a716-446655440000",
        "role": "user",
        "content": "แนะนำที่เที่ยวกรุงเทพหน่อย",
        "createdAt": "2024-01-15T10:30:00Z"
      },
      {
        "id": "660e8400-e29b-41d4-a716-446655440002",
        "sessionId": "550e8400-e29b-41d4-a716-446655440000",
        "role": "assistant",
        "content": "สวัสดีครับ! กรุงเทพมีสถานที่ท่องเที่ยวมากมาย...",
        "sources": [
          {
            "title": "ที่เที่ยวกรุงเทพ 2024",
            "url": "https://example.com/travel"
          }
        ],
        "createdAt": "2024-01-15T10:30:05Z"
      }
    ],
    "createdAt": "2024-01-15T10:30:00Z",
    "updatedAt": "2024-01-15T10:30:05Z"
  }
}
```

---

### 4.2.2 Get All Chat Sessions (รายการเซสชันทั้งหมด)

```
GET /api/v1/ai/chat
```

### Query Parameters
```typescript
interface GetAIChatSessionsRequest {
  page?: number;     // optional, default 1
  pageSize?: number; // optional, default 20, max 50
}
```

### Response
```typescript
interface AIChatSessionListResponse {
  sessions: AIChatSessionResponse[];
  meta: PaginationMeta;
}

interface AIChatSessionResponse {
  id: string;
  title: string;
  initialQuery: string;
  createdAt: string;
  updatedAt: string;
}
```

### Example Response
```json
{
  "success": true,
  "message": "Chat sessions retrieved",
  "data": {
    "sessions": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "title": "ที่เที่ยวกรุงเทพ",
        "initialQuery": "แนะนำที่เที่ยวกรุงเทพหน่อย",
        "createdAt": "2024-01-15T10:30:00Z",
        "updatedAt": "2024-01-15T10:35:00Z"
      },
      {
        "id": "550e8400-e29b-41d4-a716-446655440001",
        "title": "อาหารเชียงใหม่",
        "initialQuery": "ร้านอาหารอร่อยเชียงใหม่",
        "createdAt": "2024-01-14T15:00:00Z",
        "updatedAt": "2024-01-14T15:10:00Z"
      }
    ],
    "meta": {
      "total": 10,
      "offset": 0,
      "limit": 20
    }
  }
}
```

---

### 4.2.3 Get Chat Session Detail (รายละเอียดเซสชัน)

```
GET /api/v1/ai/chat/:sessionId
```

### Path Parameters
- `sessionId`: UUID ของ session

### Response
Same as `AIChatSessionDetailResponse`

---

### 4.2.4 Send Message (ส่งข้อความ)

```
POST /api/v1/ai/chat/:sessionId/messages
```

### Path Parameters
- `sessionId`: UUID ของ session

### Request Body
```typescript
interface SendAIChatMessageRequest {
  message: string;  // required, 1-2000 chars
}
```

### Example Request
```json
{
  "message": "แล้วมีร้านอาหารแถวนั้นไหม?"
}
```

### Response
```typescript
interface AIChatMessageResponse {
  id: string;
  sessionId: string;
  role: 'assistant';
  content: string;
  sources?: MessageSource[];
  createdAt: string;
}
```

---

### 4.2.5 Delete Chat Session (ลบเซสชัน)

```
DELETE /api/v1/ai/chat/:sessionId
```

### Response
```json
{
  "success": true,
  "message": "Chat session deleted"
}
```

---

### 4.2.6 Clear All Sessions (ลบทั้งหมด)

```
DELETE /api/v1/ai/chat
```

### Response
```json
{
  "success": true,
  "message": "All chat sessions cleared"
}
```

---

## TypeScript Types สำหรับ Frontend

```typescript
// types/ai.ts

export interface AISearchRequest {
  q: string;
  lang?: string;
}

export interface MessageSource {
  title: string;
  url: string;
  snippet?: string;
}

export interface AISearchResponse {
  query: string;
  summary: string;
  sources: MessageSource[];
  keywords?: string[];
}

export interface CreateChatRequest {
  query: string;
}

export interface SendMessageRequest {
  message: string;
}

export interface ChatMessage {
  id: string;
  sessionId: string;
  role: 'user' | 'assistant';
  content: string;
  sources?: MessageSource[];
  createdAt: string;
}

export interface ChatSession {
  id: string;
  title: string;
  initialQuery: string;
  createdAt: string;
  updatedAt: string;
}

export interface ChatSessionDetail extends ChatSession {
  messages: ChatMessage[];
}

export interface ChatSessionListResponse {
  sessions: ChatSession[];
  meta: PaginationMeta;
}

export interface PaginationMeta {
  total: number;
  offset: number;
  limit: number;
}

// Streaming chunk (สำหรับ future use)
export interface AIStreamChunk {
  type: 'content' | 'source' | 'done' | 'error';
  content?: string;
  source?: MessageSource;
  error?: string;
}
```

---

## API Routes Summary

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/api/v1/ai/search` | Optional | AI Search (ค้นหาอัจฉริยะ) |
| POST | `/api/v1/ai/chat` | Yes | สร้าง Chat Session ใหม่ |
| GET | `/api/v1/ai/chat` | Yes | รายการ Sessions ทั้งหมด |
| GET | `/api/v1/ai/chat/:sessionId` | Yes | รายละเอียด Session |
| POST | `/api/v1/ai/chat/:sessionId/messages` | Yes | ส่งข้อความ |
| DELETE | `/api/v1/ai/chat/:sessionId` | Yes | ลบ Session |
| DELETE | `/api/v1/ai/chat` | Yes | ลบ Sessions ทั้งหมด |

---

## Notes

### AI Search vs Chat
- **AI Search**: สำหรับคำถามเดี่ยว ไม่ต้อง login, cache 6 ชั่วโมง
- **AI Chat**: สำหรับการสนทนาต่อเนื่อง ต้อง login, ไม่ cache

### Markdown Format
- AI จะตอบกลับในรูปแบบ Markdown
- Frontend ควรใช้ library เช่น `react-markdown` ในการ render

### Response Time
- AI Search/Chat อาจใช้เวลา 5-15 วินาที
- ควรแสดง loading indicator ให้ผู้ใช้

### Error Handling
```json
// OpenAI rate limit
{
  "success": false,
  "message": "AI service temporarily unavailable",
  "error": "Rate limit exceeded"
}

// Invalid session
{
  "success": false,
  "message": "Chat session not found",
  "error": "Not Found"
}
```

### Caching
- AI Search: cache 6 ชั่วโมงใน Redis
- Chat: ไม่ cache (real-time conversation)
